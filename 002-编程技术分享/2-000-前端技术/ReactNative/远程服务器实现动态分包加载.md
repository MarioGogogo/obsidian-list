
>æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨ **@callstack/repack** åœ¨ React Native åº”ç”¨ä¸­å®ç°è¿œç¨‹æœåŠ¡å™¨åŠ¨æ€åˆ†åŒ…åŠ è½½åŠŸèƒ½ã€‚


---
## æ¦‚è¿°
### ä»€ä¹ˆæ˜¯ Re.Packï¼Ÿ

Re.Pack æ˜¯ä¸€ä¸ªåŸºäº Webpack çš„ React Native æ‰“åŒ…å·¥å…·ï¼Œå®ƒå°† Web å¼€å‘ä¸­æˆç†Ÿçš„"ä»£ç æ‹†åˆ†ï¼ˆCode Splittingï¼‰"å’Œ"åŠ¨æ€åŠ è½½"èƒ½åŠ›å¼•å…¥åˆ° React Native å¼€å‘ä¸­ã€‚

![](assets/è¿œç¨‹æœåŠ¡å™¨å®ç°åŠ¨æ€åˆ†åŒ…åŠ è½½/file-20260118143256274.png)

### Re.Pack vs ä¼ ç»Ÿ Metro

  

| ç‰¹æ€§ | Metroï¼ˆé»˜è®¤ï¼‰ | Re.Packï¼ˆWebpackï¼‰ |

|------|--------------|-------------------|

| æ‰“åŒ…é€»è¾‘ | æ‰€æœ‰ä»£ç æŒ¤åœ¨ä¸€ä¸ª `index.bundle` | ç‰©ç†æ‹†åˆ†ä¸ºå¤šä¸ª `.chunk.bundle` |

| æŒ‰éœ€åŠ è½½ | è¾ƒéš¾å®ç°ï¼Œéœ€åŸç”Ÿç«¯æ·±åº¦å®šåˆ¶ | åŸç”Ÿæ”¯æŒ `import()` è¯­æ³• |

| è¿œç¨‹æ›´æ–° | éœ€å…¨é‡çƒ­æ›´æ–°ï¼ˆå¦‚ CodePushï¼‰ | æ”¯æŒæŒ‰æ¨¡å—ã€æŒ‰åˆ†åŒ…è¿œç¨‹æ›´æ–° |

| ç”Ÿæ€ | ä»…é™ RN ç”Ÿæ€ | å…±äº« Webpack ä¸°å¯Œçš„ Loader å’Œ Plugin |

  

### é€‚ç”¨åœºæ™¯

  

1. **App ä¸šåŠ¡æå…¶å¤æ‚**ï¼šé›†æˆå¤šä¸ªå®Œå…¨ä¸ç›¸å…³çš„ä¸šåŠ¡æ¨¡å—

2. **åŠ¨æ€ä¸‹å‘ä¸šåŠ¡**ï¼šåƒå°ç¨‹åºä¸€æ ·åŠ¨æ€å¢åŠ æˆ–æ›´æ–°ä¸šåŠ¡æ¨¡å—

3. **å¤šå›¢é˜Ÿåä½œ**ï¼šä¸åŒå›¢é˜Ÿå¼€å‘ä¸åŒ Chunkï¼Œé€šè¿‡ Module Federation é›†æˆ

  

---

  

## å·¥ä½œåŸç†

  

### åŠ è½½ä¸å¯åŠ¨æµç¨‹

  

Re.Pack çš„å·¥ä½œæµç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š**å¯åŠ¨é˜¶æ®µ**å’Œ**è¿è¡Œé˜¶æ®µ**ã€‚

  

#### å¯åŠ¨é˜¶æ®µï¼ˆInitial Startupï¼‰

  

1. **Native å®¹å™¨åˆå§‹åŒ–**ï¼šç”¨æˆ·ç‚¹å‡» App å›¾æ ‡ï¼ŒiOS/Android åŸç”Ÿå£³å­å¯åŠ¨ï¼Œåˆå§‹åŒ– JS å¼•æ“ï¼ˆHermes æˆ– JSCï¼‰

2. **è¯·æ±‚ Main Bundle**ï¼šåŸç”Ÿç«¯å‘ Re.Pack Serverï¼ˆå¼€å‘ç¯å¢ƒï¼‰æˆ–æœ¬åœ°å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰è¯·æ±‚ `index.bundle`

3. **åŠ è½½æ ¸å¿ƒä»£ç **ï¼š`index.bundle` åŒ…å« Reactã€React Native æ¡†æ¶ä»£ç ã€å…¨å±€çŠ¶æ€ç®¡ç†ä»¥åŠé¦–é¡µåŸºç¡€é€»è¾‘

  

#### è¿è¡Œé˜¶æ®µï¼ˆDynamic Runtimeï¼‰

  

è¿™æ˜¯ Re.Pack çš„æ ¸å¿ƒä¼˜åŠ¿æ‰€åœ¨ï¼Œåˆ©ç”¨ Webpack çš„ `import()` ç‰¹æ€§ï¼š

  

1. **è§¦å‘å¯¼èˆª/æ“ä½œ**ï¼šç”¨æˆ·ç‚¹å‡»æŸä¸ªå¤æ‚åŠŸèƒ½æ¨¡å—ï¼ˆå¦‚"å•†åŸ"æˆ–"åœ°å›¾"ï¼‰

2. **é€»è¾‘åˆ¤å®š**ï¼šä»£ç æ‰§è¡Œåˆ° `import('./FeatureX')` æ—¶ï¼ŒRe.Pack çš„è¿è¡Œæ—¶æ‹¦æˆªè¯¥è¯·æ±‚

3. **Chunk åŠ è½½**ï¼š

- **æœ¬åœ°åˆ†åŒ…**ï¼šå¦‚æœæ˜¯é¢„ç½®åœ¨ App é‡Œçš„åˆ†åŒ…ï¼ŒRe.Pack é€šè¿‡åŸç”Ÿ Bridge è¯»å–å¯¹åº”çš„ JS æ–‡ä»¶

- **è¿œç¨‹åˆ†åŒ…**ï¼šå¦‚æœé…ç½®äº†è¿œç¨‹åŠ è½½ï¼ŒRe.Pack ä¼šé€šè¿‡ç½‘ç»œä¸‹è½½ `.chunk.bundle` æ–‡ä»¶

4. **åŠ¨æ€æ³¨å…¥**ï¼šä¸‹è½½å®Œæˆåçš„ JS ä»£ç è¢«æ³¨å…¥åˆ°å½“å‰çš„ JS ç¯å¢ƒä¸­

  

### åˆ†åŒ…å­˜å‚¨æœºåˆ¶

  

| å±‚çº§ | å­˜å‚¨ä½ç½® | æŒä¹…æ€§ | è¯´æ˜ |

|------|---------|--------|------|

| **æ–‡ä»¶ç¼“å­˜** | åº”ç”¨æ²™ç›’ç›®å½• | âœ… æ°¸ä¹… | é¦–æ¬¡ä¸‹è½½åå­˜å‚¨åˆ°æœ¬åœ°ï¼Œä¸‹æ¬¡å¯åŠ¨ç›´æ¥è¯»å– |

| **JS æ¨¡å—ç¼“å­˜** | å†…å­˜ | âŒ é‡å¯ä¸¢å¤± | åŠ è½½åçš„æ¨¡å—åœ¨å†…å­˜ä¸­ |

  

---

  

## å®Œæ•´é…ç½®æŒ‡å—

  

### æ­¥éª¤ 1ï¼šå®‰è£…ä¾èµ–

  

```bash

# å®‰è£… Re.Pack åŠç›¸å…³ä¾èµ–

npm install --save-dev @callstack/repack webpack terser-webpack-plugin babel-loader

  

# å®‰è£… React Native æ–‡ä»¶ç³»ç»Ÿåº“ï¼ˆç”¨äºè¿œç¨‹åŠ è½½ï¼‰

npm install react-native-fs

  

# iOS éœ€è¦æ‰§è¡Œ pod install

cd ios && pod install && cd ..

  

# åˆå§‹åŒ– Re.Pack é…ç½®ï¼ˆæ¨èï¼‰

npx @callstack/repack-init@4.4.1

```

  

åˆå§‹åŒ–å®Œæˆåä¼šè‡ªåŠ¨åˆ›å»ºï¼š

- `webpack.config.mjs` - Webpack/Rspack é…ç½®æ–‡ä»¶

- `react-native.config.js` - React Native é…ç½®æ–‡ä»¶

- æ›´æ–° `android/app/build.gradle` ä¸­çš„ `bundleCommand`

  

---

  

### æ­¥éª¤ 2ï¼šé…ç½® Rspack

  

åˆ›å»ºæˆ–ä¿®æ”¹ `rspack.config.mjs`ï¼š

  

```javascript

import path from 'node:path';

import { fileURLToPath } from 'node:url';

import * as Repack from '@callstack/repack';

  

const __filename = fileURLToPath(import.meta.url);

const __dirname = path.dirname(__filename);

  

export default Repack.defineRspackConfig({

context: __dirname,

entry: './index.js',

  

resolve: {

...Repack.getResolveOptions(),

},

  

module: {

rules: [

{

test: /\.[cm]?[jt]sx?$/,

type: 'javascript/auto',

use: {

loader: '@callstack/repack/babel-swc-loader',

parallel: true,

options: {},

},

},

...Repack.getAssetTransformRules(),

],

},

  

plugins: [

new Repack.RepackPlugin({

// å¤šåˆ†åŒ…é…ç½®ï¼šæ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹æ‰“åŒ…

extraChunks: [

{

include: /feature/,

type: 'remote',

outputPath: path.join(__dirname, 'build/output/android/remote'),

},

{

include: /settings/,

type: 'remote',

outputPath: path.join(__dirname, 'build/output/android/remote'),

},

{

include: /profile/,

type: 'remote',

outputPath: path.join(__dirname, 'build/output/android/remote'),

},

{

include: /shop/,

type: 'remote',

outputPath: path.join(__dirname, 'build/output/android/remote'),

},

{

// å…œåº•è§„åˆ™

include: /.*/,

type: 'remote',

outputPath: path.join(__dirname, 'build/output/android/remote'),

},

],

}),

],

});

```

  

---

  

### æ­¥éª¤ 3ï¼šä¿®æ”¹å…¥å£æ–‡ä»¶

  

ä¿®æ”¹ `index.js`ï¼š

  

```javascript

import { AppRegistry } from 'react-native';

import App from './src/App';

import { name as appName } from './app.json';

  

AppRegistry.registerComponent(appName, () => App);

```

  

---

  

### æ­¥éª¤ 4ï¼šåˆ›å»ºä¸»åŒ…åº”ç”¨ï¼ˆåˆ†åŒ…æ‡’åŠ è½½ï¼‰

  

åˆ›å»º `src/App.tsx`ï¼š

  

```typescript

import React, { useState, Suspense } from 'react';

import { View, Text, TouchableOpacity, StyleSheet, ActivityIndicator, SafeAreaView, ... } from 'react-native';

  

const App = () => {

const [loadMiniApp, setLoadMiniApp] = useState(false);

  

const handleLoadMiniApp = () => {

console.log('ğŸš€ å¼€å§‹åŠ è½½åˆ†åŒ…...');

setLoadMiniApp(true);

};

  

const handleUnload = () => {

console.log('ğŸ“¦ å¸è½½åˆ†åŒ…');

setLoadMiniApp(false);

};

  

return (

<SafeAreaView style={styles.container}>

<View style={styles.content}>

<Text style={styles.title}>React Native åˆ†åŒ…åŠ è½½</Text>

<Text style={styles.subtitle}>ä¸»åŒ…ï¼ˆMain Bundleï¼‰</Text>

  

{!loadMiniApp ? (

<TouchableOpacity style={styles.loadButton} onPress={handleLoadMiniApp}>

<Text style={styles.buttonText}>ğŸš€ åŠ è½½åˆ†åŒ…ï¼ˆMiniAppï¼‰</Text>

</TouchableOpacity>

) : (

<View style={styles.miniAppWrapper}>

<Suspense fallback={<LoadingView />}>

<MiniAppLoader onUnload={handleUnload} />

</Suspense>

</View>

)}

</View>

</SafeAreaView>

);

};

  

// æ‡’åŠ è½½åˆ†åŒ…ç»„ä»¶

const MiniAppLoader = ({ onUnload }: { onUnload: () => void }) => {

const MiniApp = React.lazy(() => import(

/* webpackChunkName: "miniApp" */

'./bundles/MiniApp'

));

  

return (

<View style={styles.miniAppContainer}>

<MiniApp />

<TouchableOpacity style={styles.unloadButton} onPress={onUnload}>

<Text style={styles.buttonText}>âŒ å¸è½½åˆ†åŒ…</Text>

</TouchableOpacity>

</View>

);

};

  

const LoadingView = () => (

<View style={styles.loading}>

<ActivityIndicator size="large" color="#007AFF" />

<Text style={styles.loadingText}>åŠ è½½ä¸­...</Text>

</View>

);

  

const styles = StyleSheet.create({

// ... æ ·å¼å®šä¹‰ï¼ˆcontainer, content, title, button, loading ç­‰ï¼‰

});

  

export default App;

```

  

---

  

### æ­¥éª¤ 5ï¼šåˆ›å»ºåˆ†åŒ…æ¨¡å—

  

åˆ›å»º `src/bundles/MiniApp/index.tsx`ï¼š

  

```typescript

import React, { useState, useEffect } from 'react';

import { View, Text, StyleSheet, TouchableOpacity, Animated, ... } from 'react-native';

  

const MiniApp = () => {

const [count, setCount] = useState(0);

const [fadeAnim] = useState(new Animated.Value(0));

  

useEffect(() => {

console.log('âœ… MiniApp åˆ†åŒ…åŠ è½½æˆåŠŸï¼');

Animated.timing(fadeAnim, { toValue: 1, duration: 600, useNativeDriver: true }).start();

}, []);

  

return (

<Animated.View style={[styles.container, { opacity: fadeAnim }]}>

<Text style={styles.emoji}>ğŸ‰</Text>

<Text style={styles.title}>åˆ†åŒ…å†…å®¹å·²åŠ è½½</Text>

<Text style={styles.description}>è¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ Bundleï¼ŒæŒ‰éœ€åŠ è½½ï¼</Text>

  

<View style={styles.card}>

<Text style={styles.cardTitle}>è®¡æ•°å™¨ç¤ºä¾‹</Text>

<Text style={styles.counter}>{count}</Text>

  

<View style={styles.buttonRow}>

<TouchableOpacity style={[styles.counterBtn, styles.decrementBtn]} onPress={() => setCount(c => c - 1)}>

<Text style={styles.counterBtnText}>-</Text>

</TouchableOpacity>

<TouchableOpacity style={[styles.counterBtn, styles.resetBtn]} onPress={() => setCount(0)}>

<Text style={styles.resetBtnText}>é‡ç½®</Text>

</TouchableOpacity>

<TouchableOpacity style={[styles.counterBtn, styles.incrementBtn]} onPress={() => setCount(c => c + 1)}>

<Text style={styles.counterBtnText}>+</Text>

</TouchableOpacity>

</View>

</View>

  

<View style={styles.infoBox}>

<Text style={styles.infoTitle}>ğŸ“¦ åˆ†åŒ…ç‰¹æ€§</Text>

{['ç‹¬ç«‹æ‰“åŒ…', 'æŒ‰éœ€åŠ è½½', 'å‡å°ä¸»åŒ…ä½“ç§¯', 'æ”¯æŒçƒ­æ›´æ–°'].map((item, index) => (

<Text key={index} style={styles.infoItem}>â€¢ {item}</Text>

))}

</View>

</Animated.View>

);

};

  

const styles = StyleSheet.create({

// ... æ ·å¼å®šä¹‰

});

  

export default MiniApp;

```

  

---

  

## é¡¹ç›®å‘½ä»¤

  

### å¼€å‘ç¯å¢ƒ

  

```bash

# 1. å®‰è£…ä¾èµ–

npm install

  

# 2. å¯åŠ¨ Re.Pack å¼€å‘æœåŠ¡å™¨

npm start

  

# 3. è¿è¡Œ Android / iOS

npm run android # æˆ– ios

```

  

### ç”Ÿäº§æ‰“åŒ…

  

```bash

# ç”Ÿæˆåˆ†åŒ…ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰

npm run bundle:android

```

  

### éªŒè¯æ‰“åŒ…ç»“æœ

  

```bash

# æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶

ls -lh build/output/android/remote/

  

# åº”è¯¥çœ‹åˆ°ï¼š

# index.bundle # ä¸»åŒ…

# miniApp.chunk.bundle # åˆ†åŒ…

# vendor.chunk.bundle # ç¬¬ä¸‰æ–¹åº“åˆ†åŒ…

```

  

---

  

## éªŒè¯æ¸…å•

  

```

âœ… react-native.config.js å·²åˆ›å»º

âœ… webpack.config.mjs / rspack.config.mjs å·²é…ç½®

âœ… package.json scripts å·²æ›´æ–°

âœ… ç›®å½•ç»“æ„æ­£ç¡®ï¼ˆsrc/bundles/MiniAppï¼‰

âœ… npm install å®Œæˆ

âœ… npm start èƒ½è¿è¡Œ

âœ… npm run android æˆåŠŸ

âœ… ç‚¹å‡»æŒ‰é’®èƒ½åŠ è½½åˆ†åŒ…

```

  

---

  

## å…³é”®è¦ç‚¹

  

### 1. ä¸¤ç§æ¨¡å¼éƒ½æ˜¯è¿œç¨‹åŠ è½½

  

åˆ†åŒ…ä¸åœ¨ä¸»åŒ…é‡Œï¼Œè€Œæ˜¯é€šè¿‡ç½‘ç»œè¯·æ±‚è·å–ã€‚

  

### 2. å¼€å‘æ¨¡å¼

  

åˆ†åŒ…ä» Re.Pack DevServerï¼ˆé»˜è®¤ `http://localhost:8081`ï¼‰è·å–ï¼Œæ”¯æŒçƒ­æ›´æ–°ã€‚

  

### 3. ç”Ÿäº§æ¨¡å¼

  

éœ€è¦å°† `feature.chunk.bundle` éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼Œå¹¶é…ç½®æ­£ç¡®çš„ URLã€‚

  

### 4. è¿œç¨‹åŠ è½½é…ç½®

  

åœ¨ `rspack.config.mjs` ä¸­é…ç½® `extraChunks` æ—¶ï¼Œéœ€è¦è®¾ç½® `type: 'remote'` å¹¶æŒ‡å®š `outputPath`ã€‚

  

---

  

## å¸¸è§é—®é¢˜

  

### Q: å¦‚ä½•é…ç½®è¿œç¨‹æœåŠ¡å™¨ URLï¼Ÿ

  

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéœ€è¦é€šè¿‡é…ç½®ä¸­å¿ƒæˆ– API è¿”å›åˆ†åŒ…çš„çœŸå® URLï¼š

  

```typescript

{

"miniApp": {

"url": "https://your-cdn.com/miniApp.chunk.bundle",

"version": "1.0.0"

}

}

```

  

### Q: å¦‚ä½•å®ç°ç‰ˆæœ¬æ›´æ–°ï¼Ÿ

  

é€šè¿‡ URL å‚æ•° `?v={version}` å¼ºåˆ¶åˆ·æ–°ç¼“å­˜ï¼š

  

```typescript

const bundleUrl = `https://cdn.example.com/miniApp.chunk.bundle?v=${version}`;

```

  

### Q: å¦‚ä½•å¤„ç†åŠ è½½å¤±è´¥ï¼Ÿ

  

ä½¿ç”¨ `ErrorBoundary` æ•è·åˆ†åŒ…åŠ è½½é”™è¯¯ï¼š

  

```typescript

<ChunkErrorBoundary screenName="MiniApp" onRetry={handleRetry}>

<Suspense fallback={<LoadingScreen />}>

<MiniAppLoader />

</Suspense>

</ChunkErrorBoundary>

```

  

---

  

## ç›¸å…³èµ„æº

  

- [Re.Pack å®˜æ–¹æ–‡æ¡£](https://re-pack.dev/)

- [Rspack æ–‡æ¡£](https://rspack.dev/)

- [React Native å®˜æ–¹æ–‡æ¡£](https://reactnative.dev/)

- [Webpack ä»£ç åˆ†å‰²](https://webpack.js.org/guides/code-splitting/)