# React Native æ–°æ¶æ„åŸç”Ÿäº‹ä»¶é…ç½®æŒ‡å—

  

## æ¦‚è¿°

  ![](assets/æ–°æ¶æ„åŸç”Ÿäº‹ä»¶é…ç½®æŒ‡å—/file-20260118210912206.png)

åœ¨ React Native **æ–°æ¶æ„ (The New Architecture)** ä¸­ï¼ŒåŸç”Ÿæ¨¡å—å‘ JS å‘é€äº‹ä»¶çš„æ–¹å¼ä¸æ—§æ¶æ„æˆªç„¶ä¸åŒã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•é…ç½®åŸç”Ÿäº‹ä»¶ç³»ç»Ÿã€‚

  ![](assets/æ–°æ¶æ„åŸç”Ÿäº‹ä»¶é…ç½®æŒ‡å—/file-20260118210236259.png)

### æ ¸å¿ƒæ¦‚å¿µ

  

| æ¦‚å¿µ | è¯´æ˜ |

|------|------|

| **TurboModule** | æ–°æ¶æ„åŸç”Ÿæ¨¡å—ï¼Œæ”¯æŒå¼ºç±»å‹å’Œ Codegen |

| **Callbacks** | å›è°ƒå‡½æ•°ï¼Œå•æ¬¡è°ƒç”¨ |

| **Promises** | Promise å¼‚æ­¥è¿”å› |

| **Continuous Events** | æŒç»­æ€§äº‹ä»¶ï¼Œéœ€æ˜¾å¼è®¢é˜…/å–æ¶ˆè®¢é˜… |

| **DeviceEventEmitter** | JS ç«¯äº‹ä»¶å‘å°„å™¨ |

  

---

  

## ç¬¬ä¸€æ­¥ï¼šå®šä¹‰äº‹ä»¶æ¥å£ (TypeScript)

  

åœ¨ `src/specs/` ç›®å½•ä¸‹åˆ›å»ºäº‹ä»¶æ¥å£æ–‡ä»¶ã€‚

  

```typescript

// src/specs/NativeEmitter.ts

import type { TurboModule } from 'react-native';

import { TurboModuleRegistry } from 'react-native';

import { NativeEventEmitter } from 'react-native';

  

/**

* äº‹ä»¶å›è°ƒç±»å‹å®šä¹‰

*/

export interface EventPayload {

eventId: string;

timestamp: number;

data: Record<string, unknown>;

}

  

/**

* äº‹ä»¶æ¨¡å—æ¥å£å®šä¹‰

*

* åŒ…å«ï¼š

* - getName(): è¿”å›æ¨¡å—åç§°

* - subscribe(): è®¢é˜…äº‹ä»¶ï¼ˆè¿”å›ä¸€ä¸ªå–æ¶ˆè®¢é˜…å‡½æ•°ï¼‰

* - getInitialValue(): è·å–åˆå§‹å€¼

*/

export interface Spec extends TurboModule {

/**

* è®¢é˜…åŸç”Ÿäº‹ä»¶

* @returns å–æ¶ˆè®¢é˜…çš„å›è°ƒå‡½æ•°

*/

subscribe(): void;

  

/**

* å–æ¶ˆè®¢é˜…

*/

unsubscribe(): void;

  

/**

* è·å–å½“å‰çŠ¶æ€

* @returns å½“å‰è®¡æ•°å€¼

*/

getCurrentValue(): number;

}

  

// æ¨¡å—åç§°

const MODULE_NAME = 'NativeEmitter';

  

// å¯¼å‡ºæ¨¡å—

export default TurboModuleRegistry.getEnforcing<Spec>(MODULE_NAME);

  

/**

* JS ç«¯äº‹ä»¶å‘å°„å™¨åŒ…è£…å™¨

* æ–¹ä¾¿åœ¨ç»„ä»¶ä¸­ç›‘å¬åŸç”Ÿäº‹ä»¶

*/

export class NativeEventEmitterWrapper {

private static emitter: NativeEventEmitter | null = null;

  

/**

* è·å–äº‹ä»¶å‘å°„å™¨å®ä¾‹

* å»ºè®®åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ä¸€æ¬¡

*/

static getEmitter(): NativeEventEmitter {

if (!this.emitter) {

this.emitter = new NativeEventEmitter(NativeToast);

}

return this.emitter;

}

  

/**

* æ·»åŠ äº‹ä»¶ç›‘å¬å™¨

* @param eventName äº‹ä»¶åç§°

* @param listener å›è°ƒå‡½æ•°

* @returns è®¢é˜…å¯¹è±¡ï¼ˆå¯ç”¨äºç§»é™¤ç›‘å¬ï¼‰

*/

static addListener(

eventName: string,

listener: (payload: EventPayload) => void

) {

return this.getEmitter().addListener(eventName, listener);

}

  

/**

* ç§»é™¤æ‰€æœ‰ç›‘å¬å™¨

*/

static removeAllListeners(eventName: string) {

this.getEmitter().removeAllListeners(eventName);

}

}

```

  

---

  

## ç¬¬äºŒæ­¥ï¼šé…ç½® Codegen (`package.json`)

  

```json

{

"codegenConfig": {

"name": "NativeEmitterSpecs",

"type": "modules",

"jsSrcsDir": "src/specs",

"android": {

"javaPackageName": "com.nativeexopmodules.specs"

}

}

}

```

  

---

  

## ç¬¬ä¸‰æ­¥ï¼šç¼–å†™ Kotlin åŸç”Ÿå®ç°

  

ç»§æ‰¿ Codegen ç”Ÿæˆçš„æŠ½è±¡ç±»ï¼Œå¹¶ä½¿ç”¨ `JSIModuleRegistry` å‘é€äº‹ä»¶ã€‚

  

```kotlin

// android/app/src/main/java/com/nativeexopmodules/NativeEmitterModule.kt

package com.nativeexopmodules

  

import com.facebook.react.bridge.Arguments

import com.facebook.react.bridge.ReactApplicationContext

import com.facebook.react.bridge.WritableMap

import com.facebook.react.modules.core.DeviceEventManagerModule

import com.nativeexopmodules.specs.NativeEmitterSpec

  

/**

* åŸç”Ÿäº‹ä»¶å‘å°„æ¨¡å—

*

* å®ç°åŠŸèƒ½ï¼š

* 1. å®šæ—¶å‘é€äº‹ä»¶

* 2. æ”¯æŒæ‰‹åŠ¨è§¦å‘äº‹ä»¶

* 3. æä¾›çŠ¶æ€æŸ¥è¯¢

*/

class NativeEmitterModule(reactContext: ReactApplicationContext) : NativeEmitterSpec(reactContext) {

  

companion object {

const val NAME = "NativeEmitter"

const val EVENT_NAME = "NativeEvent"

  

// äº‹ä»¶å‘é€é—´éš” (æ¯«ç§’)

private const val EVENT_INTERVAL_MS = 3000L

}

  

// äº‹ä»¶è®¡æ•°

private var eventCount = 0

  

// è®¡æ—¶å™¨å¼•ç”¨

private var timerHandler: android.os.Handler? = null

private var timerRunnable: Runnable? = null

  

// æ˜¯å¦å·²è®¢é˜…

private var isSubscribed = false

  

// äº‹ä»¶å‘é€é”

private val lock = Any()

  

override fun getName(): String = NAME

  

/**

* å‘é€åŸç”Ÿäº‹ä»¶åˆ° JS ç«¯

*/

private fun sendEvent() {

val context = reactApplicationContext ?: return

  

synchronized(lock) {

eventCount++

  

// æ„å»ºäº‹ä»¶æ•°æ®

val payload = Arguments.createMap().apply {

putString("eventId", "evt_${System.currentTimeMillis()}")

putDouble("timestamp", System.currentTimeMillis().toDouble())

putInt("count", eventCount)

putString("message", "Event #${eventCount} from Native")

}

  

// å‘é€äº‹ä»¶

context.getJSModule(DeviceEventManagerModule.RCTDeviceEventEmitter::class.java)

.emit(EVENT_NAME, payload)

}

}

  

/**

* è®¢é˜…äº‹ä»¶

* å¼€å§‹å®šæ—¶å‘é€äº‹ä»¶

*/

override fun subscribe() {

if (isSubscribed) return

  

isSubscribed = true

timerHandler = android.os.Handler(android.os.Looper.getMainLooper())

  

timerRunnable = object : Runnable {

override fun run() {

if (isSubscribed) {

sendEvent()

timerHandler?.postDelayed(this, EVENT_INTERVAL_MS)

}

}

}

  

timerHandler?.post(timerRunnable!!)

}

  

/**

* å–æ¶ˆè®¢é˜…

* åœæ­¢å®šæ—¶å‘é€

*/

override fun unsubscribe() {

isSubscribed = false

timerRunnable?.let { timerHandler?.removeCallbacks(it) }

timerRunnable = null

timerHandler = null

}

  

/**

* è·å–å½“å‰è®¡æ•°å€¼

*/

override fun getCurrentValue(): Double {

return eventCount.toDouble()

}

}

```

  

---

  

## ç¬¬å››æ­¥ï¼šåˆ›å»º Package æ³¨å†Œç±»

  

```kotlin

// android/app/src/main/java/com/nativeexopmodules/NativeEmitterPackage.kt

package com.nativeexopmodules

  

import com.facebook.react.TurboReactPackage

import com.facebook.react.bridge.NativeModule

import com.facebook.react.bridge.ReactApplicationContext

import com.facebook.react.module.model.ReactModuleInfo

import com.facebook.react.module.model.ReactModuleInfoProvider

  

/**

* åŸç”Ÿäº‹ä»¶æ¨¡å—åŒ…æ³¨å†Œç±»

*/

class NativeEmitterPackage : TurboReactPackage() {

  

override fun getModule(name: String, reactContext: ReactApplicationContext): NativeModule? {

return when (name) {

NativeEmitterModule.NAME -> NativeEmitterModule(reactContext)

else -> null

}

}

  

override fun getReactModuleInfoProvider(): ReactModuleInfoProvider {

return ReactModuleInfoProvider {

val moduleInfos = mutableMapOf<String, ReactModuleInfo>()

  

moduleInfos[NativeEmitterModule.NAME] = ReactModuleInfo(

name = NativeEmitterModule.NAME,

className = NativeEmitterModule::class.java.simpleName,

canOverrideExistingModule = false,

needsEagerInit = false,

hasConstants = false,

isCxxModule = false,

isTurboModule = true

)

  

moduleInfos

}

}

}

```

  

---

  

## ç¬¬äº”æ­¥ï¼šæ³¨å†Œ Package

  

åœ¨ `MainApplication.kt` ä¸­æ³¨å†Œï¼š

  

```kotlin

package com.nativeexopmodules

  

import android.app.Application

import com.facebook.react.PackageList

import com.facebook.react.ReactApplication

import com.facebook.react.ReactHost

import com.facebook.react.ReactNativeApplicationEntryPoint.loadReactNative

import com.facebook.react.defaults.DefaultReactHost.getDefaultReactHost

  

class MainApplication : Application(), ReactApplication {

  

override val reactHost: ReactHost by lazy {

getDefaultReactHost(

context = applicationContext,

packageList = PackageList(this).packages.apply {

add(ToastPackage())

add(NativeEmitterPackage()) // æ³¨å†Œäº‹ä»¶æ¨¡å—

},

)

}

  

override fun onCreate() {

super.onCreate()

loadReactNative(this)

}

}

```

  

---

  

## ç¬¬å…­æ­¥ï¼šåœ¨ JS ç«¯ç›‘å¬äº‹ä»¶

  

```tsx

// src/screens/EventDemoScreen.tsx

import React, { useEffect, useState } from 'react';

import { View, Text, Button, StyleSheet, ScrollView } from 'react-native';

import NativeEmitter, { NativeEventEmitterWrapper, EventPayload } from '../specs/NativeEmitter';

  

interface EventLog {

id: string;

timestamp: number;

message: string;

count: number;

}

  

export default function EventDemoScreen() {

const [currentValue, setCurrentValue] = useState(0);

const [isSubscribed, setIsSubscribed] = useState(false);

const [eventLogs, setEventLogs] = useState<EventLog[]>([]);

  

// è®¢é˜…/å–æ¶ˆè®¢é˜…

const toggleSubscription = () => {

if (isSubscribed) {

NativeEmitter.unsubscribe();

NativeEventEmitterWrapper.removeAllListeners('NativeEvent');

} else {

NativeEmitter.subscribe();

  

// ç›‘å¬åŸç”Ÿäº‹ä»¶

NativeEventEmitterWrapper.addListener('NativeEvent', (payload: EventPayload) => {

const newLog: EventLog = {

id: payload.eventId,

timestamp: payload.timestamp,

message: payload.data['message'] as string,

count: payload.data['count'] as number,

};

  

setEventLogs(prev => [newLog, ...prev].slice(0, 50)); // ä¿ç•™æœ€è¿‘ 50 æ¡

setCurrentValue(payload.data['count'] as number);

});

}

setIsSubscribed(!isSubscribed);

};

  

// è·å–å½“å‰å€¼

const handleGetValue = async () => {

const value = NativeEmitter.getCurrentValue();

setCurrentValue(value);

};

  

// æ¸…ç†

useEffect(() => {

return () => {

NativeEventEmitterWrapper.removeAllListeners('NativeEvent');

};

}, []);

  

return (

<View style={styles.container}>

<View style={styles.header}>

<Text style={styles.title}>Native Event Demo</Text>

<Text style={styles.subtitle}>React Native New Architecture</Text>

</View>

  

<View style={styles.statusSection}>

<Text style={styles.statusText}>

Status: {isSubscribed ? 'ğŸŸ¢ Subscribed' : 'ğŸ”´ Unsubscribed'}

</Text>

<Text style={styles.countText}>

Event Count: {currentValue}

</Text>

</View>

  

<View style={styles.buttonSection}>

<Button

title={isSubscribed ? 'Unsubscribe' : 'Subscribe'}

onPress={toggleSubscription}

/>

<Button

title="Get Current Value"

onPress={handleGetValue}

/>

</View>

  

<Text style={styles.sectionTitle}>Event Logs:</Text>

<ScrollView style={styles.logContainer}>

{eventLogs.map((log) => (

<View key={log.id} style={styles.logItem}>

<Text style={styles.logMessage}>{log.message}</Text>

<Text style={styles.logMeta}>Count: {log.count}</Text>

</View>

))}

</ScrollView>

</View>

);

}

  

const styles = StyleSheet.create({

container: {

flex: 1,

padding: 16,

backgroundColor: '#fff',

},

header: {

marginBottom: 20,

},

title: {

fontSize: 24,

fontWeight: 'bold',

},

subtitle: {

fontSize: 14,

color: '#666',

},

statusSection: {

padding: 16,

backgroundColor: '#f5f5f5',

borderRadius: 8,

marginBottom: 16,

},

statusText: {

fontSize: 16,

marginBottom: 8,

},

countText: {

fontSize: 20,

fontWeight: 'bold',

},

buttonSection: {

flexDirection: 'row',

justifyContent: 'space-around',

marginBottom: 16,

},

sectionTitle: {

fontSize: 18,

fontWeight: 'bold',

marginBottom: 8,

},

logContainer: {

flex: 1,

},

logItem: {

padding: 12,

backgroundColor: '#e8f4fd',

borderRadius: 8,

marginBottom: 8,

},

logMessage: {

fontSize: 14,

},

logMeta: {

fontSize: 12,

color: '#666',

marginTop: 4,

},

});

```

  

---

  

## è¿›é˜¶ï¼šä¼ é€’å¤æ‚æ•°æ®

  

### å®šä¹‰è”åˆç±»å‹äº‹ä»¶

  

```typescript

// src/specs/NativeEventTypes.ts

import type { TurboModule } from 'react-native';

import { TurboModuleRegistry } from 'react-native';

  

/**

* äº‹ä»¶ç±»å‹æšä¸¾

*/

export enum EventType {

DATA_UPDATE = 'dataUpdate',

STATE_CHANGE = 'stateChange',

ERROR = 'error',

}

  

/**

* ç»Ÿä¸€äº‹ä»¶è½½è·ç±»å‹

*/

export interface UnifiedEvent {

type: EventType;

timestamp: number;

payload: DataUpdatePayload | StateChangePayload | ErrorPayload;

}

  

/**

* æ•°æ®æ›´æ–°è½½è·

*/

export interface DataUpdatePayload {

itemId: string;

value: number;

}

  

/**

* çŠ¶æ€å˜æ›´è½½è·

*/

export interface StateChangePayload {

previousState: string;

currentState: string;

}

  

/**

* é”™è¯¯è½½è·

*/

export interface ErrorPayload {

code: string;

message: string;

}

  

/**

* äº‹ä»¶æ¨¡å—æ¥å£

*/

export interface EventSpec extends TurboModule {

subscribeToEvent(eventType: EventType): void;

unsubscribeFromEvent(eventType: EventType): void;

emitEvent(eventType: EventType, payload: Record<string, unknown>): void;

}

  

export default TurboModuleRegistry.getEnforcing<EventSpec>('UnifiedEvent');

```

  

### Kotlin ç«¯å‘é€å¤šç§äº‹ä»¶

  

```kotlin

class UnifiedEventModule(reactContext: ReactApplicationContext) : UnifiedEventSpec(reactContext) {

  

private val eventSubscriptions = mutableSetOf<String>()

private val handler = android.os.Handler(android.os.Looper.getMainLooper())

  

override fun getName(): String = "UnifiedEvent"

  

private fun emitEvent(eventType: String, payload: WritableMap) {

val jsModule = reactApplicationContext?.getJSModule(

DeviceEventManagerModule.RCTDeviceEventEmitter::class.java

)

jsModule?.emit(eventType, payload)

}

  

override fun subscribeToEvent(eventType: String?) {

eventType?.let { eventSubscriptions.add(it) }

}

  

override fun unsubscribeFromEvent(eventType: String?) {

eventType?.let { eventSubscriptions.remove(it) }

}

  

override fun emitEvent(eventType: String?, payload: ReadableMap?) {

if (eventType == null || payload == null) return

  

val writableMap = Arguments.createMap().apply {

putString("type", eventType)

putDouble("timestamp", System.currentTimeMillis().toDouble())

  

// è½¬æ¢ ReadableMap

putMap("payload", payload)

}

  

emitEvent(eventType, writableMap)

}

}

```

  

---

  

## å¸¸è§é—®é¢˜

  

### Q1: äº‹ä»¶æ”¶ä¸åˆ°ï¼Ÿ

  

1. æ£€æŸ¥æ¨¡å—æ˜¯å¦æ­£ç¡®æ³¨å†Œ

2. ç¡®è®¤ `isTurboModule = true`

3. éªŒè¯äº‹ä»¶åç§°æ˜¯å¦ä¸€è‡´

4. ç¡®ä¿åœ¨è®¢é˜…çŠ¶æ€æ—¶æ‰å‘é€äº‹ä»¶

  

### Q2: å†…å­˜æ³„æ¼ï¼Ÿ

  

**å¿…é¡»** åœ¨ç»„ä»¶å¸è½½æ—¶å–æ¶ˆè®¢é˜…ï¼š

  

```tsx

useEffect(() => {

const subscription = NativeEventEmitterWrapper.addListener(

'NativeEvent',

handleEvent

);

  

return () => {

subscription.remove(); // é‡è¦ï¼

};

}, []);

```

  

### Q3: å¦‚ä½•æµ‹è¯•åŸç”Ÿäº‹ä»¶ï¼Ÿ

  

```bash

# é‡æ–°æ„å»ºä»¥è§¦å‘ Codegen

cd android

./gradlew clean

cd ..

yarn android

```

  

---

  

## æ€»ç»“

  

| æ­¥éª¤ | æ–‡ä»¶ | è¯´æ˜ |

|------|------|------|

| 1 | `NativeEmitter.ts` | å®šä¹‰äº‹ä»¶æ¥å£ |

| 2 | `package.json` | é…ç½® Codegen |

| 3 | `NativeEmitterModule.kt` | Kotlin å®ç° |

| 4 | `NativeEmitterPackage.kt` | æ¨¡å—æ³¨å†Œ |

| 5 | `MainApplication.kt` | æ³¨å†Œ Package |

| 6 | `EventDemoScreen.tsx` | ç›‘å¬å’Œä½¿ç”¨äº‹ä»¶ |

  

**å…³é”®ç‚¹**ï¼š

- ä½¿ç”¨ `DeviceEventManagerModule.RCTDeviceEventEmitter` å‘é€äº‹ä»¶

- å§‹ç»ˆåœ¨ä¸»çº¿ç¨‹æ“ä½œ UI ç›¸å…³ä»£ç 

- ä½¿ç”¨ `synchronized` ä¿æŠ¤å…±äº«çŠ¶æ€

- è®°å¾—æ¸…ç†äº‹ä»¶ç›‘å¬å™¨é˜²æ­¢å†…å­˜æ³„æ¼